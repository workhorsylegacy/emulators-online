<!DOCTYPE html>
<html>
	<head>
		<title>Emu Archive</title>
		<script src="http://code.jquery.com/jquery-2.1.3.min.js"></script>
<style>
	.gameIcon {
		float: left;
		margin: 0px;
		padding: 5px;
		overflow: auto;
		align: center;
		min-height: 330px;
		width: 310px;
		text-align: center;
		font-family: Helvetica, Arial, "Times New Roman", Times, serif;
		font-size: 150%;
		border-radius: 15px;
	}

	img.blackAndWhite {
		filter: grayscale(100%);
		-webkit-filter: grayscale(100%);
	}

	.gameIcon img {
		padding: 0x;
		margin: 0px;
		margin-top: 5px;
		width: 300px;
		border-radius: 15px;
	}

	.gameIcon:hover {
		background-color: #CCCCCC;
	}

	.gameDialog {
		position: fixed;
		font-family: Helvetica, Arial, "Times New Roman", Times, serif;
		top: 0;
		right: 0;
		bottom: 0;
		left: 0;
		background: rgba(0, 0, 0, 0.8);
		z-index: 99999;
		opacity:0;
		transition: opacity 300ms ease-in;
		pointer-events: none;
	}

	.gameDialog:target {
		opacity:1;
		pointer-events: auto;
	}

	.gameDialog img {
		width: 300px;
	}

	.gameDialog > div {
		position: relative;
		width: 80%;
		height: 80%;
		margin: auto;
		margin-top: 20px;
		padding: 20px;
		border-radius: 15px;
		background: #CCCCCC;
	}

	.closeGameDialog {
		background: #606061;
		color: #FFFFFF;
		line-height: 25px;
		position: absolute;
		right: -12px;
		text-align: center;
		top: -10px;
		width: 24px;
		text-decoration: none;
		font-weight: bold;
		border-radius: 15px;
		box-shadow: 1px 1px 3px #000;
	}

	.closeGameDialog:hover {
		background: #FF0000;
	}

	#not_connected {
		background-color: red;
		font-size: 250%;
		margin: 10px;
	}
</style>
	</head>
	<body>
		<div id="not_connected" style="display: none">
			Not connected to server!
		</div>

		Search: <input id="search_text" type="text" />

		<div id="game_dialogs"></div>

		<div id="game_selector" style="overflow: auto;"></div>

		<br style="clear: both"/>

		<div id="output"></div>
		
		<footer>
		  <p>Copyright &copy; 2015 Matthew Brennan Jones</p>
		  <p><a href="https://github.com/workhorsy/emu_archive">https://github.com/workhorsy/emu_archive</a></p>
		</footer>
	</body>
</html>

<script language="JavaScript">

var db = {};
var socket = null;

jQuery(function($) {

if(!("WebSocket" in window)) {
	alert("Your browser does not support web sockets");
} else {
	// Load the game databases
	$.when(
		$.getJSON("db/saturn.json", function (data) {
			db['Saturn'] = data;
		}),
		$.getJSON("db/playstation.json", function (data) {
			db['Playstation'] = data;
		}),
		$.getJSON("db/gamecube.json", function (data) {
			db['GameCube'] = data;
		}),
		$.getJSON("db/nintendo64.json", function (data) {
			db['Nintendo64'] = data;
		}),
		$.getJSON("db/dreamcast.json", function (data) {
			db['Dreamcast'] = data;
		})
	).then(function() {
		setup();
	});
}

// FIXME: The way we construct these divs dynamically is terrible. Replace with templates.
function make_game_icon(console_name, name, data, i) {
	// Create the icon
	var text = "" +
			"<a href=\"#dialog_" + name + "\" id=\"preview_" + i + "\">";
			
	if(data["binary"])
		text += "<img src=\"" + data["path"] + "00000000.png\" />";
	else
		text += "<img src=\"" + data["path"] + "00000000.png\" class=\"blackAndWhite\" />";

	text += "<br />" + 
		name + "</a>";
	var d = document.createElement('div');
	d.className = "gameIcon";
	d.innerHTML = text;
	document.getElementById('game_selector').appendChild(d);

	// Create the dialog
	var text = "" +
	"<div>" +
	"	<a href=\"#closeGameDialog\" class=\"closeGameDialog\">X</a>" + 
	"	<h2>" + name + "</h2>" + 
	"	<img src=\"" + data["path"] + "00000000.png\" />" +
	"	<input id=\"btn_" + i + "\" type=\"button\" value=\"play\" \>" +
	"	<br />";

	$.each(data["images"], function(n, image) {
		if(n != 0)
			text += "	<img src=\"" + data["path"] + image + "\" />";
	});

	text += "</div>";

	var d = document.createElement('div');
	d.id = "dialog_" + name;
	d.className = "gameDialog";
	d.innerHTML = text;
	document.getElementById('game_dialogs').appendChild(d);

	// Have the dialog play button launch the game
	var btn = $("#btn_" + i);
	btn.on('click', function() {
		var message = {
			'action' : 'play',
			'name' : name,
			'path' : data['path'],
			'binary' : data['binary'],
			'console' : console_name,
			'bios' : data['bios']
		}
		var message = JSON.stringify(message);
		socket.send(message);
	});
}

function get_searchable_words(search_string) {
	// Get all the words in the name that are at least 3 characters long
	var all_words = search_string.toLowerCase().match(/\S+/g);
	var search_words = [];
	$.each(all_words, function(i, word) {
		if(word.length > 2) {
			search_words.push(word.toLowerCase());
		}
	});

	return search_words;
}

function on_search() {
	var search_text = $('#search_text');

	// Get the words to search for
	var search_raw = search_text.val();
///*
	// Skip empty searches
	if(search_raw.length == 0) {
		var i = 0;
		$.each(db, function(console_name, console_data) {
			// Add console name as header
			var d = document.createElement('h1');
			d.innerHTML = console_name;
			d.style.clear = "both";
			document.getElementById('game_selector').appendChild(d);

			$.each(console_data, function(name, data) {
				make_game_icon(console_name, name, data, i);
				++i;
			});
		});
		return;
	}
//*/
///*
	// Match game genre
	var match_genre_db = [];
	var lower_search = search_raw.toLowerCase();
	$.each(db, function(console_name, console_data) {
		$.each(console_data, function(name, data) {
			if('genre' in data && data['genre'].toLowerCase() == lower_search) {
				//console.log(name + " : " + data['genre']);
				match_genre_db.push(name);
			}
		});
	});
//*/
///*
	// Match whole game name
	var match_whole_db = [];
	var lower_search = search_raw.toLowerCase();
	$.each(db, function(console_name, console_data) {
		$.each(console_data, function(name, data) {
			// Skip if game was found in the genre search
			var already_searched = false;
			$.each(match_genre_db, function(n, gname) {
				if(name.toLowerCase() == gname.toLowerCase()) {
					already_searched = true;
					return false;
				}
			});
			if(already_searched)
				return false;

			if(name.toLowerCase() == lower_search) {
				match_whole_db.push(name);
			}
		});
	});
//*/
///*
	// Match some words in game name
	var match_words_db = {};
	var search_words = get_searchable_words(search_raw);

	$.each(db, function(console_name, console_data) {
		$.each(console_data, function(name, data) {

			// Skip if game was found in whole search
			var already_searched = false;
			$.each(match_whole_db, function(n, gname) {
				if(name.toLowerCase() == gname.toLowerCase()) {
					already_searched = true;
					return false;
				}
			});
			if(already_searched)
				return false;

			var game_words = get_searchable_words(name);

			// Count how many words match the search
			var match_count = 0;
			$.each(search_words, function(i, search_word) {
				$.each(game_words, function(j, game_word) {
					if(game_word == search_word) {
						++match_count;
					}
				});
			});
			if(match_count > 0) {
				// Init the hash if empty
				if(!(name in match_words_db))
					match_words_db[name] = 0;

				// Save the match count if bigger
				if(match_count > match_words_db[name])
					match_words_db[name] = match_count;
			}
		});
	});
//*/
///*
	// Match parts of words in game name
	var match_parts_db = {};
	var search_words = get_searchable_words(search_raw);

	$.each(db, function(console_name, console_data) {
		$.each(console_data, function(name, data) {
			// Skip if game was found in words search
			var already_searched = false;
			$.each(match_words_db, function(gname, gcount) {
				if(name.toLowerCase() == gname.toLowerCase()) {
					already_searched = true;
					return false;
				}
			});
			if(already_searched)
				return false;

			var game_words = get_searchable_words(name);

			// Count how many words match the search
			var match_count = 0;
			$.each(search_words, function(i, search_word) {
				$.each(game_words, function(j, game_word) {
					if(search_word.indexOf(game_word) > -1 || game_word.indexOf(search_word) > -1) {
						++match_count;
					}
				});
			});
			if(match_count > 0) {
				// Init the hash if empty
				if(!(name in match_parts_db))
					match_parts_db[name] = 0;

				// Save the match count if bigger
				if(match_count > match_parts_db[name])
					match_parts_db[name] = match_count;
			}
		});
	});
//*/

	// Clear the old icons
	document.getElementById('game_selector').innerHTML = "";

	// Create new icons from the search
	var i = 0;
	$.each(db, function(console_name, console_data) {
		// Add console name as header
		var d = document.createElement('h1');
		d.innerHTML = console_name;
		d.style.clear = "both";
		document.getElementById('game_selector').appendChild(d);

		$.each(console_data, function(name, data) {
///*
			// Genre matches
			$.each(match_genre_db, function(n, gname) {
				if(name == gname)
					make_game_icon(console_name, name, data, i);
			});
//*/
///*
			// Whole matches
			$.each(match_whole_db, function(n, gname) {
				if(name == gname)
					make_game_icon(console_name, name, data, i);
			});
//*/
///*
			// Word matches
			$.each(match_words_db, function(gname, gcount) {
				if(name == gname)
					make_game_icon(console_name, name, data, i);
			});
//*/
///*
			// Part matches
			$.each(match_parts_db, function(gname, gcount) {
				if(name == gname)
					make_game_icon(console_name, name, data, i);
			});
//*/
			++i;
		});
	});
}

function setup() {
	var host = "ws://localhost:9090/ws";
	socket = new WebSocket(host);

	$('#search_text').on('input propertychange paste', on_search);

	// Show the default search
	on_search();

	// event handlers for websocket
	if(socket) {
		socket.onopen = function() {
			$("#not_connected").hide();
		}

		socket.onmessage = function(msg) {
			showServerResponse(msg.data);
		}

		socket.onclose = function() {
			$("#not_connected").show();
		}
	} else {
		console.log("invalid socket");
	}

	function showServerResponse(txt) {
		if(txt == "playing") {
			
		} else {
			var p = document.createElement('p');
			p.innerHTML = txt;
			document.getElementById('output').appendChild(p);
		}
	}


}

});
</script>